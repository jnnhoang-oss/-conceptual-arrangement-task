<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Conceptual Arrangement Task</title>
<style>
  html, body {
    margin: 0; padding: 0;
    height: 100%; overflow: hidden;
    background-color: #222;
    color: white; font-family: Arial, sans-serif;
  }
  .visible { display: block; }
  .hidden { display: none; }
  #instruction, #questions, #endScreen {
    text-align: center; padding: 2rem; display: none;
  }
  #instruction.visible, #questions.visible, #endScreen.visible {
    display: block;
  }
  #arenaContainer {
    position: relative; width: 100vw; height: 100vh;
    display: none; background: #333;
  }
  #arena {
    position: absolute; top: 50%; right: 15%;
    transform: translateY(-50%);
    width: 500px; height: 500px;
    border: 3px dashed #ffcc00; border-radius: 50%;
    background: rgba(255,255,255,0.05);
  }
  #timerDisplay {
    position: absolute; top: 10px; left: 10px;
  }
  #arenaText {
    position: absolute; bottom: 15px; width: 100%;
    text-align: center; font-style: italic;
  }
  .image {
    position: absolute;
    width: 20px; height: 20px;
    border-radius: 10px;
    cursor: grab;
    transition: transform 0.05s linear;
  }
  .image:active { cursor: grabbing; transform: scale(1.05); }
  .question-btn {
    margin: 10px; padding: 10px 20px;
    background-color: #ffcc00; border: none; border-radius: 6px;
    cursor: pointer; font-weight: bold;
  }
  #warningMessage {
    position: absolute; top: 10%; width: 100%;
    text-align: center; color: red;
    font-weight: bold; display: none;
  }
</style>
</head>
<body>
  <!-- INSTRUCTION -->
  <div id="instruction" class="visible">
    <h1>Conceptual Arrangement Task</h1>
    <p>Press <b>SPACE</b> to start.</p>
  </div>

  <!-- ARENA -->
  <div id="arenaContainer">
    <div id="arena"></div>
    <div id="timerDisplay">
      <p>Total Time: <span id="totalTime">0</span>s</p>
    </div>
    <div id="arenaText">Click and drag images. Press ENTER when finished.</div>
    <div id="warningMessage">âš  Please move all images inside the arena before continuing.</div>
  </div>

  <!-- QUESTIONS -->
  <div id="questions">
    <div id="q1" class="question">
      <h2>Did you pay attention (BE HONEST)?</h2>
      <button class="question-btn" onclick="recordAnswer('attention','Yes')">Yes</button>
      <button class="question-btn" onclick="recordAnswer('attention','No')">No</button>
    </div>
    <div id="q2" class="question" style="display:none;">
      <h2>Are you using the same device as before?</h2>
      <button class="question-btn" onclick="recordAnswer('device','Yes')">Yes</button>
      <button class="question-btn" onclick="recordAnswer('device','No')">No</button>
    </div>
  </div>

  <!-- END SCREEN -->
  <div id="endScreen">
    <h2>Thank you for participating!</h2>
    <p>Your data has been saved.</p>
  </div>

<script>
  //~~~~~~~~` Whatever ~~~~~~
  const arenaContainer = document.getElementById("arenaContainer");
  const arena = document.getElementById("arena");
  const instruction = document.getElementById("instruction");
  const questions = document.getElementById("questions");
  const endScreen = document.getElementById("endScreen");
  const totalTimeDisplay = document.getElementById("totalTime");
  const warningMessage = document.getElementById("warningMessage");

  let participantID = prompt("Enter Participant ID:");
  let startTime, timerInterval;
  let attentionAnswer = "", deviceAnswer = "";
  let positions = {};
  let totalSeconds = 0;
  let arenaVisible = false;

  // ~~~~~~~ IMG ~~~~~~~
  const imageFolder = ".github/wth/";
  const imageNames = [
    "aardvark.jpg","anteater.jpg","camel.jpg","tiger.jpg","rabbit.jpg","horse.jpg"
  ];

  function loadImages() {
    imageNames.forEach((name, i) => {
      const img = document.createElement("img");
      img.src = imageFolder + name;
      img.className = "image";
      img.style.left = "5%";
      img.style.top = `${10 + i * 12}%`;
      arenaContainer.appendChild(img);
    });
  }

  // ~~~~~~` DRAGGING ~~~~~~~`
  let active = null;
  let offsetX = 0, offsetY = 0;

  function enableDragging() {
    const imgs = document.querySelectorAll(".image");
    imgs.forEach(img => {
      img.addEventListener("mousedown", e => {
        active = e.target;
        offsetX = e.offsetX;
        offsetY = e.offsetY;
      });
    });

    document.addEventListener("mousemove", e => {
      if (!active) return;
      const x = e.pageX - offsetX;
      const y = e.pageY - offsetY;
      active.style.left = x + "px";
      active.style.top = y + "px";
    });

    document.addEventListener("mouseup", () => {
      if (active) {
        const rect = active.getBoundingClientRect();
        const key = active.src.split("/").pop();
        positions[key] = { x: rect.left, y: rect.top };
        active = null;
      }
    });
  }

  // ~~~~~~~~~TIMER ~~~~~~~`
  function startTimer() {
    startTime = new Date();
    timerInterval = setInterval(() => {
      totalSeconds = Math.floor((new Date() - startTime) / 1000);
      totalTimeDisplay.textContent = totalSeconds;
    }, 1000);
  }

  // ~~~~~~~~~~`ARENA CHECK ~~~~~~~~~~~~
  function isInsideArena(img) {
    const arenaRect = arena.getBoundingClientRect();
    const arenaCenterX = arenaRect.left + arenaRect.width / 2;
    const arenaCenterY = arenaRect.top + arenaRect.height / 2;
    const radius = arenaRect.width / 2;

    const imgRect = img.getBoundingClientRect();
    const imgCenterX = imgRect.left + imgRect.width / 2;
    const imgCenterY = imgRect.top + imgRect.height / 2;

    const dx = imgCenterX - arenaCenterX;
    const dy = imgCenterY - arenaCenterY;
    const distance = Math.sqrt(dx * dx + dy * dy);

    return distance + imgRect.width / 2 < radius;
  }

  function allImagesInside() {
    const imgs = document.querySelectorAll(".image");
    return Array.from(imgs).every(isInsideArena);
  }

  // ~~~~~~~~~~~ QUESTIONS ~~~~~~~~~~`
  function recordAnswer(type, answer) {
    if (type === "attention") {
      attentionAnswer = answer;
      document.getElementById("q1").style.display = "none";
      document.getElementById("q2").style.display = "block";
    } else {
      deviceAnswer = answer;
      questions.classList.remove("visible");
      saveCSV();
      endScreen.classList.add("visible");
    }
  }

  // ~~~~~~~~~~~~`SAVE CSV ~~~~~~~~~~~
  function saveCSV() {
    let csv = "ParticipantID,Time,Attention,Device,Image,X,Y\n";
    for (let key in positions) {
      const p = positions[key];
      csv += `${participantID},${totalSeconds},${attentionAnswer},${deviceAnswer},${key},${p.x},${p.y}\n`;
    }
    const blob = new Blob([csv], { type: "text/csv" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `arrangement_${participantID}.csv`;
    a.click();
  }

  // ~~~~~~~~~~~ CONTROLS ~~~~~~~~~`
  document.addEventListener("keydown", e => {
    if (e.code === "Space" && !arenaVisible) {
      instruction.classList.remove("visible");
      arenaContainer.style.display = "block";
      loadImages();
      enableDragging();
      arenaVisible = true;
      startTimer();
    } else if (e.code === "Enter" && arenaVisible) {
      const imgs = document.querySelectorAll(".image");
      imgs.forEach(img => {
        const rect = img.getBoundingClientRect();
        const key = img.src.split("/").pop();
        positions[key] = { x: rect.left, y: rect.top };
      });

      if (allImagesInside()) {
        warningMessage.style.display = "none";
        arenaContainer.style.display = "none";
        clearInterval(timerInterval);
        questions.classList.add("visible");
      } else {
        warningMessage.style.display = "block";
      }
    }
  });
</script>
</body>
</html>
